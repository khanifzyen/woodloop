<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoodLoop - Aggregator Map</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
        }

        .map-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Marker Customization */
        .custom-pin {
            background-color: #E53935;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .action-float-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="mobile-frame" style="position: relative;">
        <!-- Map Container -->
        <div id="map"></div>

        <!-- Floating Buttons -->
        <div class="action-float-btn" onclick="navigateTo('aggregator-inventory.html')" style="top: 20px;">
            üì¶
        </div>
        <div class="action-float-btn" onclick="navigateTo('chat.html')" style="top: 80px;">
            üí¨
        </div>
        <div class="action-float-btn" onclick="navigateTo('notifications.html')" style="top: 140px;">
            üîî
        </div>

        <!-- Overlay Status -->
        <div class="map-overlay">
            <h3 style="font-size: 16px; font-weight: 700;">Halo, Mas Yono!</h3>
            <p style="font-size: 12px; color: #666;">Ada <strong id="wasteCount">0</strong> titik limbah siap jemput
                hari ini.</p>
            <button class="btn btn-primary mt-4" onclick="navigateTo('aggregator-orders.html')">Lihat Rute
                Jemput</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div
        style="background: white; padding: 16px; display: flex; justify-content: space-around; border-top: 1px solid #eee; position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000; border-radius: 0 0 30px 30px;">
        <div class="text-center" style="color: var(--primary-color); cursor: pointer;" onclick="location.reload()">
            <div style="font-size: 20px;">üó∫Ô∏è</div>
            <div style="font-size: 10px; font-weight: 600;">Map</div>
        </div>
        <div class="text-center" style="opacity: 0.5; cursor: pointer;"
            onclick="navigateTo('aggregator-inventory.html')">
            <div style="font-size: 20px;">üì¶</div>
            <div style="font-size: 10px;">Gudang</div>
        </div>
        <div class="text-center" style="opacity: 0.5; cursor: pointer;" onclick="navigateTo('profile.html')">
            <div style="font-size: 20px;">üë§</div>
            <div style="font-size: 10px;">Profil</div>
        </div>
    </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Map (Center on Jepara)
            var map = L.map('map').setView([-6.5888, 110.6680], 13);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // 2. Get Data
            seedDataIfEmpty();
            const wasteData = getWasteData();
            const pendingWaste = wasteData.filter(item => item.status === 'Menunggu Penjemputan');

            // Update Counter
            document.getElementById('wasteCount').textContent = pendingWaste.length;

            // 3. Add Markers
            pendingWaste.forEach(item => {
                // If no lat/lng, mock it randomly around Jepara
                const lat = item.lat || (-6.58 + (Math.random() * 0.02 - 0.01));
                const lng = item.lng || (110.66 + (Math.random() * 0.02 - 0.01));

                const marker = L.marker([lat, lng]).addTo(map);

                const popupContent = `
                    <div style="width: 200px;">
                        <img src="${item.image}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
                        <div style="font-weight: 700; font-size: 14px;">${item.type}</div>
                        <div style="font-size: 12px; color: #666;">${item.weight} Kg ‚Ä¢ ${formatRupiah(item.price)}</div>
                        <button class="btn btn-primary" style="padding: 8px; font-size: 12px; margin-top: 8px;" onclick="pickUpItem('${item.id}')">Angkut Sekarang</button>
                    </div>
                `;

                marker.bindPopup(popupContent);
            });
        });

        // Function called from popup
        function pickUpItem(id) {
            if (confirm("Apakah Anda yakin ingin menjemput barang ini?")) {
                updateWasteStatus(id, 'Diangkut');
                alert("Status berhasil diubah menjadi 'Diangkut'. Cek menu Inventory.");
                location.reload(); // Refresh map
            }
        }
    </script>
</body>

</html>